<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout | CaptureCore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/js/inline-validator.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <%- include('../partial/user/navbar') %>
  <div class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6 flex items-center gap-3">
      Checkout
      <span id="savingAddressBadge" class="hidden text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Saving address...</span>
      <% if (isBuyNow) { %>
        <span class="text-sm text-green-600 font-normal">(Buy Now)</span>
      <% } %>
    </h1>

    <% if (typeof retry !== 'undefined' && retry) { %>
      <div class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-yellow-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          <div>
            <h3 class="text-sm font-medium text-yellow-800">Retrying Payment</h3>
            <p class="text-sm text-yellow-700 mt-1">Your previous payment attempt failed. Please review your details and try again.</p>
          </div>
        </div>
      </div>
    <% } %>

    <!-- START FORM -->
    <form action="/place-order" method="POST">
      <% if (isBuyNow && buyNowProduct) { %>
        <input type="hidden" name="productId" value="<%= buyNowProduct._id %>">
        <input type="hidden" name="quantity" value="<%= buyNowProduct.quantity %>">
      <% } %>
      <input type="hidden" name="totalAmount" value="<%= finalTotal %>">

      <!-- Address Section -->
      <div class="mb-8">
        <h2 class="text-xl font-semibold mb-4">Shipping Address</h2>

        <% if (addresses && addresses.length > 0) { %>
          <div class="grid gap-6 md:grid-cols-2" id="addresses-container">
            <% addresses.forEach(address => { %>
              <label class="border rounded-lg p-5 shadow-sm bg-white cursor-pointer flex gap-4 hover:border-blue-300 transition-colors address-card" data-address-id="<%= address._id %>">
                <input 
                  type="radio" 
                  name="addressId" 
                  value="<%= address._id %>" 
                  class="accent-blue-600 mt-1"
                  required
                  <%= (defaultAddress && defaultAddress === address._id.toString()) ? 'checked' : '' %>
                >
                <div class="flex-1">
                  <h3 class="text-lg font-semibold address-name"><%= address.fullName %></h3>
                  <p class="address-details"><%= address.addressLine %>, <%= address.city %>, <%= address.state %>, <%= address.pincode %></p>
                  <p class="address-phone">Phone: <%= address.phone %></p>
                  <% if (defaultAddress === address._id.toString()) { %>
                    <span class="text-sm text-green-600 font-medium">Default Address</span>
                  <% } %>
                </div>
                <button type="button" class="text-blue-600 text-sm hover:underline edit-address-btn self-start" data-address-id="<%= address._id %>">Edit</button>
              </label>
            <% }) %>
          </div>
        <% } else { %>
          <p class="text-gray-500">No address found.</p>
        <% } %>

        <div class="mt-4 flex gap-3">
          <a href="/addresses" class="inline-block bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">Manage Addresses</a>
          <button type="button" id="openAddAddressModal" class="inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add New Address</button>
        </div>
      </div>

      <!-- Order Items -->
      <div class="mb-8">
        <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
        <div class="space-y-4">
          <% items.forEach(item => { %>
            <div class="flex gap-4 items-center bg-white p-4 rounded shadow">
              <img 
                src="<%= item.image %>" 
                onerror="this.onerror=null; this.src='/images/placeholder.png';" 
                class="w-20 h-20 object-cover rounded" 
                alt="Product Image">
              <div class="flex-1">
                <h3 class="font-medium"><%= item.name %></h3>
                <p>Quantity: <%= item.quantity %></p>
              </div>
              <div class="text-right">
                <p class="text-lg font-semibold">
                  ‚Çπ<%= item.itemTotal.toLocaleString('en-IN', { minimumFractionDigits: 2 }) %>
                </p>
              </div>
            </div>
          <% }) %>
        </div>
      </div>

      <!-- Price Summary -->
      <div class="bg-white p-6 rounded shadow mb-8">
        <h2 class="text-xl font-semibold mb-4">Price Summary</h2>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span>Subtotal</span>
            <span>‚Çπ<%= subtotal.toFixed(2) %></span>
          </div>
          <div class="flex justify-between">
            <span>Tax (5%)</span>
            <span>‚Çπ<%= tax.toFixed(2) %></span>
          </div>
          <div class="flex justify-between">
            <span>Discount</span>
            <span>- ‚Çπ<%= discount.toFixed(2) %></span>
          </div>
          <div class="flex justify-between">
            <span>Shipping</span>
            <span>‚Çπ<%= shipping.toFixed(2) %></span>
          </div>
          <div class="border-t pt-2 flex justify-between font-semibold text-lg">
            <span>Total</span>
            <span>‚Çπ<%= finalTotal.toFixed(2) %></span>
          </div>
        </div>
      </div>

      <!-- Payment Method -->
      <div class="bg-white p-6 rounded shadow mb-8">
        <h2 class="text-xl font-semibold mb-4">Select Payment Method</h2>
        <div class="flex gap-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="paymentMethod" value="COD" checked class="peer hidden">
            <div class="peer-checked:ring-2 peer-checked:ring-green-500 bg-gray-100 p-3 rounded-full transition">
              üíµ Cash on Delivery
            </div>
          </label>
          <label class="flex items-center gap-2 cursor-pointer opacity-100" id="rzpOptionLabel">
            <input type="radio" name="paymentMethod" value="Razorpay" class="peer hidden" id="rzpOption">
            <div class="peer-checked:ring-2 peer-checked:ring-blue-500 bg-gray-100 p-3 rounded-full transition">
              üßæ Razorpay (Card/UPI/Netbanking)
            </div>
          </label>
        </div>
        <p id="paymentNote" class="text-xs text-gray-500 mt-2">Select Razorpay to pay online.</p>
        <p id="rzpCapNote" class="text-xs text-red-600 mt-1 hidden"></p>
      </div>

      <!-- Submit Button -->
      <button type="submit" id="placeOrderBtn" class="w-full bg-green-600 text-white py-3 rounded text-lg hover:bg-green-700">
        Place Order
      </button>

    </form>
    <!-- END FORM -->
  </div>

<!-- Address Edit Modal -->
<div id="editAddressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
  <div class="bg-white rounded-lg p-8 w-full max-w-md relative shadow-xl">
    <button id="closeEditModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    <h2 class="text-2xl font-semibold mb-6">Edit Address</h2>
    
    <form id="editAddressForm" action="/addresses/edit" method="POST">
      <input type="hidden" name="addressId" id="editAddressId">
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
        <input type="text" name="fullName" id="editName" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" data-required>
      </div>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
        <input type="text" name="addressLine" id="editStreet" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" data-required>
      </div>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
        <input type="text" name="city" id="editCity" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" data-required>
      </div>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
        <input type="text" name="state" id="editState" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" data-required>
      </div>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Pincode</label>
        <input type="text" name="pincode" id="editZipCode" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" data-required maxlength="6" pattern="[0-9]*" inputmode="numeric">
      </div>
      
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
        <input type="text" name="phone" id="editPhone" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" data-required maxlength="10" pattern="[0-9]*" inputmode="numeric">
      </div>
      
      <div class="mb-6">
        <label class="flex items-center gap-2">
          <input type="checkbox" name="isDefault" id="editIsDefault" class="rounded">
          <span class="text-sm text-gray-700">Set as default address</span>
        </label>
      </div>
      
      <div class="flex gap-3">
        <button type="button" id="cancelEdit" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">Cancel</button>
        <button type="submit" id="saveAddressBtn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">Save Address</button>
      </div>
    </form>
  </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-60 hidden">
  <div class="bg-white rounded-lg p-6 flex items-center gap-3">
    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
    <span>Updating address...</span>
  </div>
</div>

<!-- Pass addresses data to JavaScript -->
<script type="application/json" id="addresses-data"><%- JSON.stringify(addresses || []) %></script>

  <script>
  let addresses = [];
  
  // Load addresses data safely
  try {
    const addressesElement = document.getElementById('addresses-data');
    if (addressesElement && addressesElement.textContent.trim()) {
      addresses = JSON.parse(addressesElement.textContent);
      console.log('Successfully loaded addresses:', addresses);
    } else {
      console.log('No addresses data found');
    }
  } catch (e) {
    console.error('Error loading addresses data:', e);
    // Fallback: try to extract from the DOM
    try {
      const addressCards = document.querySelectorAll('.address-card');
      addresses = Array.from(addressCards).map(card => {
        return {
          _id: card.dataset.addressId,
          fullName: card.querySelector('.address-name')?.textContent || '',
          addressLine: '', // extract below if needed
          city: '',
          state: '',
          pincode: '',
          phone: card.querySelector('.address-phone')?.textContent.replace('Phone: ', '') || ''
        };
      });
      console.log('Fallback addresses extracted:', addresses);
    } catch (fallbackError) {
      console.error('Fallback extraction failed:', fallbackError);
      addresses = [];
    }
  }

  // Modal elements
  const modal = document.getElementById('editAddressModal');
  const form = document.getElementById('editAddressForm');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const savingBadge = document.getElementById('savingAddressBadge');

  // Debug: Check if addresses data loaded
  console.log('Loaded addresses:', addresses);
  console.log('Found edit buttons:', document.querySelectorAll('.edit-address-btn').length);

  // Edit button click handlers
  document.querySelectorAll('.edit-address-btn').forEach((btn, index) => {
    console.log(`Setting up button ${index}:`, btn);
    
    btn.addEventListener('click', function(e) {
      console.log('Edit button clicked!');
      e.preventDefault();
      e.stopPropagation(); // Prevent radio button selection
      
      const addressId = this.dataset.addressId;
      console.log('Address ID:', addressId);
      
      // Try to find address in our data
      let address = addresses.find(a => a._id === addressId);
      
      // If not found in data, extract from DOM as fallback
      if (!address) {
        console.log('Address not found in data, extracting from DOM');
        const card = document.querySelector(`.address-card[data-address-id="${addressId}"]`);
        if (card) {
          const name = card.querySelector('.address-name')?.textContent || '';
          const details = card.querySelector('.address-details')?.textContent || '';
          const phone = card.querySelector('.address-phone')?.textContent.replace('Phone: ', '') || '';
          
          // Parse address details (format: "addressLine, city, state, pincode")
          const detailsParts = details.split(', ');
          
          address = {
            _id: addressId,
            fullName: name,
            addressLine: detailsParts[0] || '',
            city: detailsParts[1] || '',
            state: detailsParts[2] || '',
            pincode: detailsParts[3] || '',
            phone: phone,
            isDefault: card.querySelector('.text-green-600') !== null
          };
          console.log('Extracted address from DOM:', address);
        }
      }
      
      console.log('Using address:', address);
      
      if (address) {
        // Populate modal form
        document.getElementById('editAddressId').value = address._id;
        document.getElementById('editName').value = address.fullName || '';
        document.getElementById('editStreet').value = address.addressLine || '';
        document.getElementById('editCity').value = address.city || '';
        document.getElementById('editState').value = address.state || '';
        document.getElementById('editZipCode').value = address.pincode || '';
        document.getElementById('editPhone').value = address.phone || '';
        document.getElementById('editIsDefault').checked = address.isDefault || false;
        
        // Update form action to include address ID
        document.getElementById('editAddressForm').action = `/addresses/edit/${address._id}`;
        
        console.log('About to show modal');
        // Show modal
        modal.style.display = 'flex';
        document.getElementById('editName').focus();
      } else {
        console.error('Address not found with ID:', addressId);
        alert('Address not found. Please refresh the page.');
      }
    });
  });

  // Close modal handlers
  document.getElementById('closeEditModal').addEventListener('click', closeModal);
  document.getElementById('cancelEdit').addEventListener('click', closeModal);
  
  // Close modal when clicking outside
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });

  function closeModal() {
    modal.style.display = 'none';
    form.reset();
  }

  // Attach generic inline validator (server-driven)
  console.log('Attaching inline validation to edit form...');
  window.attachInlineValidation(form);
  console.log('Inline validation attached to edit form');



  // Update address card in the UI
  function updateAddressCard(addressId) {
    const addressCard = document.querySelector(`.address-card[data-address-id="${addressId}"]`);
    if (addressCard) {
      const address = addresses.find(a => a._id === addressId);
      if (address) {
        addressCard.querySelector('.address-name').textContent = address.fullName;
        addressCard.querySelector('.address-details').textContent = 
          `${address.addressLine}, ${address.city}, ${address.state}, ${address.pincode}`;
        addressCard.querySelector('.address-phone').textContent = `Phone: ${address.phone}`;
      }
    }
  }
  // Save address via AJAX to stay on checkout
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!validateAllFields(form)) return;
    loadingOverlay.classList.remove('hidden');
    savingBadge?.classList.remove('hidden');

    const formData = new URLSearchParams(new FormData(form));
    try {
      const res = await fetch(form.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData.toString()
      });

      if (res.ok) {
        const data = await res.json();
        const idx = addresses.findIndex(a => a._id === data.address._id);
        if (idx >= 0) {
          addresses[idx] = data.address;
        }
        updateAddressCard(data.address._id);
        
        // If the updated address is now default, auto-select it
        if (data.address.isDefault) {
          // Uncheck all other radio buttons
          document.querySelectorAll('input[name="addressId"]').forEach(radio => {
            radio.checked = false;
          });
          
          // Check the updated address
          const updatedAddressRadio = document.querySelector(`input[name="addressId"][value="${data.address._id}"]`);
          if (updatedAddressRadio) {
            updatedAddressRadio.checked = true;
            
            // Update visual feedback
            document.querySelectorAll('.address-card').forEach(card => {
              card.classList.remove('border-blue-500', 'bg-blue-50');
            });
            
            const selectedCard = updatedAddressRadio.closest('.address-card');
            if (selectedCard) {
              selectedCard.classList.add('border-blue-500', 'bg-blue-50');
            }
          }
        }
        
        closeModal();
        showNotification('Address updated.', 'success');
      } else {
        let data = null;
        try { data = await res.json(); } catch (_) {}
        if (data && data.errors) {
          showErrors(form, data.errors);
        } else {
          showNotification('Failed to update address', 'error');
        }
      }
    } catch (err) {
      console.error(err);
      showNotification('Network error', 'error');
    } finally {
      loadingOverlay.classList.add('hidden');
      savingBadge?.classList.add('hidden');
    }
  });

  // Show notification
  function showNotification(message, type = 'info') {
    // Remove any existing notification
    const existingNotification = document.getElementById('notification');
    if (existingNotification) {
      existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.id = 'notification';
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-md text-white z-70 ${
      type === 'success' ? 'bg-green-500' : 
      type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 3000);
  }

  // Handle keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal.style.display !== 'none') {
      closeModal();
    }
  });

  // Auto-select default address on page load
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Checkout page loaded, checking for default address...');
    const defaultAddressRadio = document.querySelector('input[name="addressId"]:checked');
    if (defaultAddressRadio) {
      const defaultAddressCard = defaultAddressRadio.closest('.address-card');
      if (defaultAddressCard) {
        // Highlight the default address card
        defaultAddressCard.classList.add('border-blue-500', 'bg-blue-50');
        console.log('‚úÖ Default address auto-selected:', defaultAddressRadio.value);
      }
    } else {
      console.log('‚ö†Ô∏è No default address found or selected');
    }
  });

  // Razorpay checkout handling
  (function setupRazorpay(){
    const formEl = document.querySelector('form[action="/place-order"]');
    const placeBtn = document.getElementById('placeOrderBtn');
    const totalAmount = <%- JSON.stringify(finalTotal || 0) %>;
    const isBuyNow = <%- JSON.stringify(!!isBuyNow) %>;
    const buyNowProductId = <%- JSON.stringify(buyNowProduct ? buyNowProduct._id : null) %>;
    const buyNowQty = <%- JSON.stringify(buyNowProduct ? buyNowProduct.quantity : null) %>;
    const MAX_RZP_AMOUNT = 500000;

    // Disable Razorpay option if total exceeds cap
    try {
      const rzpInput = document.getElementById('rzpOption');
      const rzpLabel = document.getElementById('rzpOptionLabel');
      const capNote = document.getElementById('rzpCapNote');
      if (Number(totalAmount) > MAX_RZP_AMOUNT) {
        if (rzpInput) {
          rzpInput.disabled = true;
          if (rzpInput.checked) {
            const cod = document.querySelector('input[name="paymentMethod"][value="COD"]');
            if (cod) cod.checked = true;
          }
        }
        if (rzpLabel) rzpLabel.classList.add('opacity-50');
        if (capNote) {
          capNote.textContent = `Amount exceeds Razorpay limit (Rs. ${MAX_RZP_AMOUNT.toLocaleString('en-IN')}). Please use COD or split the order.`;
          capNote.classList.remove('hidden');
        }
      }
    } catch(_) {}

    function paymentMethodSelected(){
      const selected = document.querySelector('input[name="paymentMethod"]:checked');
      return selected ? selected.value : 'COD';
    }

    async function createRazorpayOrder(amount){
      const res = await fetch('/razorpay/create-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount })
      });
      let data; try { data = await res.json(); } catch(e) { data = { success:false, message:'Invalid server response' }; }
      if (!res.ok || !(data && (data.sucess || data.success))) {
        throw new Error(data && data.message ? data.message : 'Failed to create payment order');
      }
      return data;
    }

    function ensureRazorpayScript(){
      return new Promise((resolve, reject) => {
        if (window.Razorpay) return resolve();
        const s = document.createElement('script');
        s.src = 'https://checkout.razorpay.com/v1/checkout.js';
        s.onload = () => resolve();
        s.onerror = reject;
        document.body.appendChild(s);
      });
    }

    async function handleRazorpayFlow(e){
      e.preventDefault();
      placeBtn.disabled = true;
      try{
        await ensureRazorpayScript();
        const orderResp = await createRazorpayOrder(totalAmount);

        const options = {
          key: orderResp.key,
          amount: orderResp.amount,
          currency: orderResp.currency,
          name: 'CaptureCore',
          description: 'Order Payment',
          order_id: orderResp.orderId,
          modal: {
            ondismiss: function(){
              submitPaymentFailure('User closed Razorpay before completing payment');
            }
          },
          handler: async function (response){
            try{
              const verifyRes = await fetch('/razorpay/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(response)
              });
              const verifyJson = await verifyRes.json();
              if(verifyRes.ok && verifyJson.sucess){
                // On success, submit the original order form to create order in DB with Razorpay method
                const pmInput = formEl.querySelector('input[name="paymentMethod"][value="Razorpay"]');
                if(pmInput) pmInput.checked = true;
                // Attach payment details so backend can persist and set status Paid
                const f = new FormData(formEl);
                const setHidden = (name, value) => {
                  let el = formEl.querySelector(`input[name="${name}"]`);
                  if (!el) {
                    el = document.createElement('input');
                    el.type = 'hidden';
                    el.name = name;
                    formEl.appendChild(el);
                  }
                  el.value = value || '';
                };
                setHidden('razorpay_order_id', response.razorpay_order_id);
                setHidden('razorpay_payment_id', response.razorpay_payment_id);
                setHidden('razorpay_signature', response.razorpay_signature);
                formEl.submit();
              } else {
                // Payment verification failed - redirect to payment failure page
                const formData = new FormData(formEl);
                const amount = formData.get('totalAmount') || totalAmount;
                window.location.href = `/payment-failure?amount=${amount}`;
              }
            }catch(err){
              console.error(err);
              // Payment verification error - redirect to payment failure page
              const formData = new FormData(formEl);
              const amount = formData.get('totalAmount') || totalAmount;
              window.location.href = `/payment-failure?amount=${amount}`;
            } finally {
              placeBtn.disabled = false;
            }
          },
          theme: { color: '#2563eb' }
        };
        const rzp = new window.Razorpay(options);
        try {
          rzp.on('payment.failed', function(){
            submitPaymentFailure('Payment failed by Razorpay');
          });
        } catch(_) {}
        rzp.open();
      }catch(err){
        console.error('Razorpay init error', err);
        // Razorpay initialization failed - create failed order and redirect
        submitPaymentFailure('Unable to initialize Razorpay');
        placeBtn.disabled = false;
      }
    }

    function submitPaymentFailure(reason){
      try {
        const selectedAddress = document.querySelector('input[name="addressId"]:checked');
        const addressId = selectedAddress ? selectedAddress.value : '';
        const productIdInput = formEl.querySelector('input[name="productId"]');
        const quantityInput = formEl.querySelector('input[name="quantity"]');
        const totalInput = formEl.querySelector('input[name="totalAmount"]');

        const tempForm = document.createElement('form');
        tempForm.method = 'POST';
        tempForm.action = '/payment-failure';

        const add = (name, value) => {
          const inp = document.createElement('input');
          inp.type = 'hidden';
          inp.name = name;
          inp.value = value == null ? '' : value;
          tempForm.appendChild(inp);
        };

        add('addressId', addressId);
        add('paymentMethod', 'Razorpay');
        if (productIdInput) add('productId', productIdInput.value);
        if (quantityInput) add('quantity', quantityInput.value);
        add('amount', totalInput ? totalInput.value : totalAmount);
        add('failureReason', reason || 'Payment failed');

        document.body.appendChild(tempForm);
        tempForm.submit();
      } catch(_) {
        const amount = (function(){ try { return (new FormData(formEl)).get('totalAmount') || totalAmount; } catch(e){ return totalAmount; } })();
        window.location.href = `/payment-failure?amount=${amount}`;
      }
    }

    if (formEl && placeBtn){
      formEl.addEventListener('submit', function(e){
        if (paymentMethodSelected() === 'Razorpay') {
          handleRazorpayFlow(e);
        }
      });
    }
  })();

  // Handle address selection to update visual feedback
  document.querySelectorAll('input[name="addressId"]').forEach(radio => {
    radio.addEventListener('change', function() {
      // Remove highlight from all address cards
      document.querySelectorAll('.address-card').forEach(card => {
        card.classList.remove('border-blue-500', 'bg-blue-50');
      });
      
      // Add highlight to selected address card
      if (this.checked) {
        const selectedCard = this.closest('.address-card');
        if (selectedCard) {
          selectedCard.classList.add('border-blue-500', 'bg-blue-50');
        }
      }
    });
  });
</script>

<!-- Add Address Modal -->
<div id="addAddressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
  <div class="bg-white rounded-lg p-8 w-full max-w-md relative shadow-xl">
    <button id="closeAddModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    <h2 class="text-2xl font-semibold mb-6">Add Address</h2>

    <form id="addAddressForm" action="/addresses" method="POST">
      <!-- Error Display Area -->
      <div id="formErrors" class="mb-4 hidden">
        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md">
          <ul id="errorList" class="list-disc list-inside text-sm"></ul>
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
        <input type="text" name="fullName" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-required placeholder="Enter your full name (letters only)">
        <div class="field-error text-red-500 text-xs mt-1 hidden"></div>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
        <input type="text" name="phone" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-required maxlength="10" pattern="[0-9]*" inputmode="numeric" placeholder="10-digit mobile number">
        <div class="field-error text-red-500 text-xs mt-1 hidden"></div>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
        <input type="text" name="addressLine" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-required placeholder="Street address, apartment, suite, etc.">
        <div class="field-error text-red-500 text-xs mt-1 hidden"></div>
      </div>
      <div class="grid grid-cols-2 gap-3 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
          <input type="text" name="city" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-required placeholder="City name (letters only)">
          <div class="field-error text-red-500 text-xs mt-1 hidden"></div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
          <input type="text" name="state" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-required placeholder="State name (letters only)">
          <div class="field-error text-red-500 text-xs mt-1 hidden"></div>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Pincode</label>
          <input type="text" name="pincode" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-required maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="6-digit pincode">
          <div class="field-error text-red-500 text-xs mt-1 hidden"></div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
          <input type="text" name="country" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="India" data-required placeholder="Country name">
          <div class="field-error text-red-500 text-xs mt-1 hidden"></div>
        </div>
      </div>
      <div class="mb-6">
        <label class="flex items-center gap-2">
          <input type="checkbox" name="isDefault" class="rounded">
          <span class="text-sm text-gray-700">Set as default address</span>
        </label>
      </div>
      <div class="flex gap-3">
        <button type="button" id="cancelAdd" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">Cancel</button>
        <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save Address</button>
      </div>
    </form>
  </div>
  </div>

<script>
  // Add Address modal wiring
  const addModal = document.getElementById('addAddressModal');
  const openAddModalBtn = document.getElementById('openAddAddressModal');
  const closeAddModalBtn = document.getElementById('closeAddModal');
  const cancelAddBtn = document.getElementById('cancelAdd');
  const addForm = document.getElementById('addAddressForm');
  if (addForm) { 
    console.log('Attaching inline validation to add form...');
    window.attachInlineValidation(addForm); 
    console.log('Inline validation attached to add form');
  }

  function showAddModal(){ 
    console.log('Opening add modal...');
    addModal.style.display = 'flex'; 
    console.log('Modal should be visible now');
  }
  function hideAddModal(){ 
    console.log('Hiding add modal...');
    addModal.style.display = 'none'; 
    addForm.reset(); 
  }

  console.log('Setting up add modal event listeners...');
  console.log('openAddModalBtn:', openAddModalBtn);
  console.log('addModal:', addModal);
  
  if (openAddModalBtn) {
    openAddModalBtn.addEventListener('click', function(e) {
      console.log('Add button clicked!');
      e.preventDefault();
      showAddModal();
    });
  }
  
  if (closeAddModalBtn) {
    closeAddModalBtn.addEventListener('click', hideAddModal);
  }
  
  if (cancelAddBtn) {
    cancelAddBtn.addEventListener('click', hideAddModal);
  }
  
  if (addModal) {
    addModal.addEventListener('click', (e) => { 
      if (e.target === addModal) {
        console.log('Clicked outside modal, closing...');
        hideAddModal(); 
      }
    });
  }

  // Add input restrictions for phone and pincode fields
  const phoneInputs = document.querySelectorAll('input[name="phone"]');
  const pincodeInputs = document.querySelectorAll('input[name="pincode"]');
  
  // Phone input restrictions
  phoneInputs.forEach(input => {
    input.addEventListener('input', function(e) {
      // Remove any non-digit characters
      let value = e.target.value.replace(/\D/g, '');
      
      // Limit to 10 digits
      if (value.length > 10) {
        value = value.slice(0, 10);
      }
      
      e.target.value = value;
    });
  });
  
  // Pincode input restrictions
  pincodeInputs.forEach(input => {
    input.addEventListener('input', function(e) {
      // Remove any non-digit characters
      let value = e.target.value.replace(/\D/g, '');
      
      // Limit to 6 digits
      if (value.length > 6) {
        value = value.slice(0, 6);
      }
      
      e.target.value = value;
    });
  });

  // Add validation for name fields (only letters and spaces)
  const nameInputs = document.querySelectorAll('input[name="fullName"], input[name="city"], input[name="state"]');
  nameInputs.forEach(input => {
    input.addEventListener('input', function(e) {
      // Remove any non-letter characters except spaces
      let value = e.target.value.replace(/[^A-Za-z\s]/g, '');
      
      // Remove multiple consecutive spaces
      value = value.replace(/\s+/g, ' ');
      
      e.target.value = value;
    });
  });

  // Add validation for address field (allow alphanumeric, spaces, and common punctuation)
  const addressInputs = document.querySelectorAll('input[name="addressLine"]');
  addressInputs.forEach(input => {
    input.addEventListener('input', function(e) {
      // Remove any invalid characters
      let value = e.target.value.replace(/[^a-zA-Z0-9\s.,!@#$%^&*()\-_=+<>?;:'"\/\\[\]{}|`~]/g, '');
      
      e.target.value = value;
    });
  });

  // Custom submit handler for add address form to stay in checkout
  addForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Clear previous errors
    clearErrors();
    
    // Let the inline validator handle validation first
    const isValid = validateAllFields(addForm);
    if (!isValid) {
      return false;
    }
    
    // If validation passes, submit via AJAX
    const formData = new FormData(addForm);
    const urlSearchParams = new URLSearchParams();
    formData.forEach((value, key) => urlSearchParams.append(key, value));
    
    try {
      const response = await fetch('/addresses', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: urlSearchParams.toString()
      });
      
      if (response.ok) {
        const data = await response.json();
        
        // Success - reload to show the new address
        window.location.reload();
      } else {
        // Handle validation errors
        const errorData = await response.json();
        
        if (errorData.errors && Object.keys(errorData.errors).length > 0) {
          showValidationErrors(errorData.errors);
        } else if (errorData.error) {
          showGeneralError(errorData.error);
        } else {
          showGeneralError('Failed to add address. Please try again.');
        }
      }
    } catch (error) {
      console.error('Error adding address:', error);
      showGeneralError('Network error. Please try again.');
    }
  });

  // Function to clear all errors
  function clearErrors() {
    const formErrors = document.getElementById('formErrors');
    const fieldErrors = document.querySelectorAll('.field-error');
    
    if (formErrors) formErrors.classList.add('hidden');
    fieldErrors.forEach(error => {
      error.classList.add('hidden');
      error.textContent = '';
    });
    
    // Remove error styling from inputs
    const inputs = addForm.querySelectorAll('input');
    inputs.forEach(input => {
      input.classList.remove('border-red-500');
      input.classList.add('border-gray-300');
    });
  }

  // Function to show validation errors
  function showValidationErrors(errors) {
    const formErrors = document.getElementById('formErrors');
    const errorList = document.getElementById('errorList');
    
    if (formErrors && errorList) {
      errorList.innerHTML = '';
      Object.values(errors).forEach(errorArray => {
        if (Array.isArray(errorArray)) {
          errorArray.forEach(error => {
            const li = document.createElement('li');
            li.textContent = error;
            errorList.appendChild(li);
          });
        }
      });
      formErrors.classList.remove('hidden');
    }
    
    // Show field-specific errors
    Object.keys(errors).forEach(fieldName => {
      const input = addForm.querySelector(`[name="${fieldName}"]`);
      const errorDiv = input ? input.parentNode.querySelector('.field-error') : null;
      
      if (input && errorDiv) {
        input.classList.remove('border-gray-300');
        input.classList.add('border-red-500');
        errorDiv.textContent = errors[fieldName][0];
        errorDiv.classList.remove('hidden');
      }
    });
  }

  // Function to show general error
  function showGeneralError(message) {
    const formErrors = document.getElementById('formErrors');
    const errorList = document.getElementById('errorList');
    
    if (formErrors && errorList) {
      errorList.innerHTML = `<li>${message}</li>`;
      formErrors.classList.remove('hidden');
    }
  }
</script>

</body>
</html>